<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Student Client</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 720px; margin: 20px auto; line-height: 1.5; }
    button { padding: 10px 14px; font-size: 16px; }
    .log { white-space: pre-wrap; border: 1px solid #ddd; padding: 12px; border-radius: 8px; margin-top: 12px; }
    input[type=text]{ width: 100%; padding: 8px; margin-top: 8px; }
  </style>
</head>
<body>
  <h2>School Voice Bot — Student (UI v1)</h2>

  <h3>Voice Q&A</h3>
  <button id="rec">Start Recording</button>
  <div class="log" id="log">Ready.</div>
  <audio id="player" controls></audio>

  <h3>Text Q&A (debug)</h3>
  <input id="q" type="text" placeholder="예: 오늘 2학년 3반 시간표 알려줘" />
  <button id="ask">Ask</button>

<script>
const recBtn = document.getElementById('rec');
const log = document.getElementById('log');
const player = document.getElementById('player');
const askBtn = document.getElementById('ask');
const qInput = document.getElementById('q');

let mediaRecorder, chunks = [], recording = false;

async function startRec() {
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm" });
  chunks = [];
  mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) chunks.push(e.data); };
  mediaRecorder.onstop = async () => {
    const blob = new Blob(chunks, { type: "audio/webm" });
    await sendAudio(blob);
  };
  mediaRecorder.start();
  recording = true;
  recBtn.textContent = "Stop Recording";
}

function stopRec() {
  if (mediaRecorder && recording) {
    mediaRecorder.stop();
    recording = false;
    recBtn.textContent = "Start Recording";
  }
}

async function sendAudio(blob) {
  log.textContent = "Uploading audio...";
  const form = new FormData();
  form.append("audio", blob, "q.webm");
  const res = await fetch("/api/ask-audio", { method: "POST", body: form });
  const json = await res.json();

  log.textContent = `Transcript: ${json.transcript}\nAnswer: ${json.answer}`;
  playB64(json.audio_b64, json.mime || "audio/mpeg");
}

function playB64(b64, mime) {
  const audioBytes = atob(b64);
  const buf = new Uint8Array(audioBytes.length);
  for (let i = 0; i < audioBytes.length; i++) buf[i] = audioBytes.charCodeAt(i);
  const audioBlob = new Blob([buf], { type: mime });
  player.src = URL.createObjectURL(audioBlob);
  player.play();
}

recBtn.onclick = () => recording ? stopRec() : startRec();

askBtn.onclick = async () => {
  const q = qInput.value.trim();
  if (!q) return;
  const params = new URLSearchParams({ q });
  const res = await fetch("/api/ask-text", { method: "POST", body: params });
  const json = await res.json();
  log.textContent = `Answer: ${json.answer}`;
  playB64(json.audio_b64, json.mime || "audio/mpeg");
};
</script>
</body>
</html>
